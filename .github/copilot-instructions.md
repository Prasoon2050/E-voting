# Copilot Instructions

- **System Overview**: Backend under `server/` exposes REST APIs with Express, MongoDB, JWT auth, and AWS S3/Rekognition for biometric checks. Frontend in `client/` is a Vite + React dashboard for admins (registration) and voters (login, vote, results). Hyperledger Fabric code remains in `blockchain/` but is not wired into the current API surface.
- **Startup Flow**: `server/app.js` loads env vars, connects to Mongo via `server/config/db.js`, seeds three default admins + demo candidates via `server/config/seed.js`, and mounts routes for admins, voters, votes, and results. Remember that `seedInitialData` logs seeded accounts on boot.
- **Environment**: `.env` must define `MONGODB_URI`, `JWT_SECRET`, `AWS_REGION`, `S3_BUCKET`, `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`; optional `FACE_SIMILARITY` tunes Rekognition thresholds (default 75). Missing `S3_BUCKET` triggers a runtime warning.
- **Auth Model**: JWT helpers live in `server/middleware/auth.js`. Admin and voter logins return tokens containing `role` plus `adminId` or `voterId`; use `authenticate()` then `requireRole([...])` on routes. Tokens default to 2-hour expiry.
- **Data Models**: Mongo schemas sit in `server/models/`. `Admin` stores `adminId`, email, bcrypt hash, and last login. `Voter` tracks credentials, Aadhaar, S3 face key, verification timestamps, and registering admin. `Candidate` lists ballot choices. `Vote` enforces one vote per voter (unique index) and records face similarity scores.
- **File Handling**: All face uploads use Multer memory storage (`multer.memoryStorage()`). Controllers must read `req.file.buffer`; nothing is written to disk. S3 helper `uploadToS3(buffer, key, contentType)` performs persistence, while `getObjectFromS3` + `compareFaces` return buffers and Rekognition matches.
- **Registration Flow**: `POST /api/admin/login` authenticates seeded officers (`admin-001..003`). With a valid admin token, `POST /api/voters/register` accepts multipart form data (`fullName`, `aadharNumber`, `password`, `image`); the controller mints a random 20-char voter hash, stores the face at `faces/<hash>.jpg`, and returns the hash to share with the voter.
- **Voter Journey**: `POST /api/voters/login` accepts `identifier` (either voter hash or Aadhaar) plus password and returns a JWT. `POST /api/votes/cast` expects voter auth plus multipart (`candidateId`, `image`); it verifies the face, checks Mongo for prior participation (without storing candidate choices), then calls Fabric `CastVote(candidateId)` to increment ledger counts. Votes are anonymous on-chain; Mongo only tracks that a voter has participated.
- **Candidate Data**: `server/config/seed.js` seeds three sample candidates (C1–C3) and attempts to register them on the Fabric ledger at startup. `GET /api/votes/candidates` returns sorted candidate metadata for the ballot dropdown.
- **Frontend Hooks**: React pages live in `client/src/pages/`. `CameraCapture.jsx` drives webcam capture for registration and voting. Admin registration surfaces the generated voter hash, voter login accepts hash/Aadhaar, voters capture a fresh photo for each ballot, and results polling hits `/api/results`. Admins can trigger `/api/results/finalize` from the UI to publish ledger totals. Auth state is persisted via `client/src/context/AuthContext.jsx` (localStorage-backed).
- **Dependency Notes**: Run `npm install` in both `server/` (adds `bcryptjs` + `jsonwebtoken`) and `client/` before development. Backend scripts include `npm run dev` (nodemon) and `npm start`. Frontend uses `npm run dev` via Vite on port 5173.
- **Result Publication**: Ledger tallies remain hidden until an admin calls `POST /api/results/finalize`, which evaluates Fabric `GetResults`, persists totals (including aggregate voter count) in `ResultStatus`, and unlocks `GET /api/results`. Until then the API returns `{ status: "pending" }` and the UI shows “Vote counting not started.”
- **Error Handling**: The global Express error handler emits `{ error: message }` with status 500. Prefer throwing to bubble up; avoid sending multiple responses manually. JWT middleware returns 401/403 with concise JSON bodies.
- **Testing Status**: No automated tests. When authoring new ones, mock AWS Rekognition, S3 interactions (`server/config/aws.js`), and Fabric gateway calls (`server/config/fabric-connection.js`). Seed Mongo collections explicitly to avoid relying on startup seeding.
